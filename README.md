# Outlook Auto Backup System

Microsoft Outlook 메일을 자동으로 MSG 파일로 백업하는 VBA 매크로 시스템입니다.

## 📋 주요 기능

- ✅ **자동 백업**: 새 메일 수신 및 발송 시 자동으로 MSG 파일로 저장
- ✅ **중복 저장 방지**: EntryID 기반으로 동일 메일 중복 저장 방지
- ✅ **폴더별 분류**: Inbox와 Sent 폴더를 자동으로 구분하여 저장
- ✅ **연도/월 구조**: 날짜 기반 폴더 구조로 체계적인 관리
- ✅ **수동 백업**: 기존 메일을 선택하여 일괄 백업 가능
- ✅ **기간별 백업**: 오늘 기준 이전 한 달 / 1년 / 2년 / 3년치 메일 일괄 백업
- ✅ **로그 시스템**: 성공/에러 로그 자동 기록 (월별 로테이션)
- ✅ **파일명 최적화**: Windows 경로 제한(260자) 자동 준수

## 📁 폴더 구조

```
D:\Outlook_Backup\
├── Inbox\
│   └── 2025\
│       └── 01\
│           ├── 20250113_143022_sender_subject.msg
│           └── 20250113_144530_sender_subject.msg
├── Sent\
│   └── 2025\
│       └── 01\
│           ├── 20250113_150012_recipient_subject.msg
│           └── 20250113_151045_recipient_subject.msg
└── logs\
    ├── 2025-01_success.log
    ├── 2025-01_error.log
    └── saved_entries.txt
```

**파일명 형식**: `yyyymmdd_hhnnss_person_subject.msg`
- **Inbox**: 발신자 이름 사용
- **Sent**: 첫 번째 수신자 이름 사용

## 🚀 설치 방법

### 1. VBA 매크로 활성화

1. **Outlook 실행**
2. **파일 → 옵션 → 보안 센터 → 보안 센터 설정**
3. **매크로 설정** 선택
4. **"알림을 표시하는 모든 매크로 사용"** 선택
5. ✅ **"VBA 프로젝트 개체 모델에 안전하게 액세스" 체크** (선택사항)
6. **확인** 클릭

### 2. VBA 코드 등록

1. **Outlook에서 Alt + F11** (VBA 편집기 열기)
2. **왼쪽 프로젝트 탐색기**에서 `ThisOutlookSession` 더블클릭
3. `script_msg.vba` 파일의 **전체 코드를 복사**하여 붙여넣기
4. **Ctrl + S** 저장

### 3. 백업 경로 설정 (필요시)

기본 경로는 `D:\Outlook_Backup\`입니다. 변경하려면:

```vba
' 코드 상단의 이 줄을 수정하세요
Private Const BACKUP_BASE_PATH As String = "D:\Outlook_Backup\"
```

원하는 경로로 변경 후 저장:
```vba
Private Const BACKUP_BASE_PATH As String = "C:\MyBackup\"
```

### 4. 이벤트 핸들러 활성화

**방법 A: Outlook 재시작** (자동 활성화)
- Outlook을 완전히 종료 후 다시 실행

**방법 B: 수동 실행** (재시작 없이)
1. **Alt + F8** (매크로 실행 창)
2. **`InitializeEventHandler`** 선택
3. **실행** 클릭
4. 확인 메시지 표시 → 활성화 완료

## 📖 사용 방법

### 자동 백업

이벤트 핸들러가 활성화되면:
- **메일 수신 시**: 자동으로 `Inbox\` 폴더에 저장
- **메일 발송 시**: 자동으로 `Sent\` 폴더에 저장

별도 작업 불필요, 백그라운드에서 자동 실행됩니다.

### 수동 백업 (기존 메일 백업)

1. **Outlook에서 백업할 메일 선택** (다중 선택 가능: Ctrl/Shift)
2. **Alt + F8** (매크로 실행)
3. **`SaveSelectedMailsAsMSG`** 선택
4. **실행** 클릭
5. 완료 메시지 확인

**참고**:
- 50개 이상 선택 시 확인 메시지 표시
- 메일이 속한 폴더를 자동 감지하여 Inbox/Sent로 분류
- 이미 저장된 메일은 자동으로 건너뛰고 개수 표시

### 기간별 메일 백업 (한 달 / 1년 / 2년 / 3년)

오늘 날짜 기준 이전 기간의 메일을 일괄 백업합니다.

1. **Alt + F8** (매크로 실행)
2. 아래 매크로 중 하나 선택 후 **실행** 클릭
3. 백업 완료 후 결과 메시지 확인

| 매크로 이름 | 백업 기간 |
|------------|----------|
| `BackupLastMonthMails` | 이전 **한 달치** |
| `BackupLastYearMails` | 이전 **1년치** |
| `BackupLast2YearsMails` | 이전 **2년치** |
| `BackupLast3YearsMails` | 이전 **3년치** |

**기능**:
- 오늘 날짜 기준 이전 기간 메일 자동 백업
- Inbox와 Sent 폴더 모두 백업
- 이미 저장된 메일은 자동으로 건너뜀
- 백업 결과 통계 표시 (총 개수, 저장 개수, 건너뛴 개수)

**참고**:
- 백업 시간은 메일 개수에 따라 다를 수 있습니다 (연 단위는 시간이 더 걸릴 수 있음)
- 중복 메일은 자동으로 건너뛰어 빠르게 처리됩니다

## 📊 로그 시스템

### 성공 로그
**경로**: `D:\Outlook_Backup\logs\yyyy-mm_success.log`

**형식**:
```
2025-01-13 14:30:22 | SUCCESS | D:\Outlook_Backup\Inbox\2025\01\20250113_143022_sender_subject.msg | 45,234 bytes | John Doe | Meeting Schedule
2025-01-13 15:00:00 | MANUAL_BACKUP (한 달치) | 총 150개 중 120개 저장, 30개 건너뜀
```

### 에러 로그
**경로**: `D:\Outlook_Backup\logs\yyyy-mm_error.log`

**형식**:
```
2025-01-13 14:35:10 | 파일 저장 실패: D:\Outlook_Backup\... | sender@example.com | Important Document
```

### 중복 저장 인덱스
**경로**: `D:\Outlook_Backup\logs\saved_entries.txt`

**설명**: 저장된 메일의 EntryID를 기록하여 중복 저장을 방지합니다.
- 한 줄에 하나의 EntryID 기록
- 자동으로 관리되며 수동 편집 불필요
- EntryID는 Outlook이 각 메일에 부여하는 고유 식별자입니다

로그 파일은 월별로 자동 로테이션됩니다.

## ⚙️ 고급 설정

### 파일명 길이 제한 조정

코드의 `SaveMailAsMSG` 함수에서 조정 가능:

```vba
' 발신자/수신자 부분 최대 길이 (기본: 50자)
If Len(senderPart) > 50 Then
    senderPart = Left(senderPart, 50)
End If
```

### 파일 크기 검증 임계값

```vba
' 비정상 파일 크기 임계값 (기본: 100 bytes)
If fileSize < 100 Then
    LogError mail, "파일 크기 비정상: " & fullPath
End If
```

## 🔧 트러블슈팅

### 1. 자동 백업이 작동하지 않음

**원인**: 이벤트 핸들러가 활성화되지 않음

**해결**:
- Outlook 완전 재시작
- 또는 `InitializeEventHandler` 매크로 수동 실행 (Alt+F8)

### 2. "매크로를 실행할 수 없습니다" 오류

**원인**: 매크로 보안 설정

**해결**:
1. 파일 → 옵션 → 보안 센터 → 보안 센터 설정
2. 매크로 설정 → "알림을 표시하는 모든 매크로 사용" 선택

### 3. 한글 파일명이 깨짐

**원인**: 발신자/제목에 특수문자 포함

**해결**:
- 자동으로 특수문자를 언더스코어(`_`)로 치환합니다
- 코드의 `CleanFileName` 함수가 자동 처리

### 4. 경로가 너무 길다는 오류

**원인**: Windows 260자 경로 제한

**해결**:
- 코드가 자동으로 파일명을 조정합니다
- 백업 경로를 더 짧게 변경 (예: `D:\OLB\`)

### 5. Sent 폴더 백업이 안 됨

**원인**: 이벤트 핸들러가 Sent 폴더를 등록하지 못함

**해결**:
- `InitializeEventHandler` 재실행
- 에러 로그 확인: `logs\yyyy-mm_error.log`

### 6. VBA 편집기에서 한글 주석이 깨짐

**원인**: 파일 인코딩 문제

**해결**:
- VBA 편집기에서 직접 수정하면 자동으로 시스템 인코딩 적용
- 또는 한글 주석을 영문으로 변경

## 🔐 보안 고려사항

### 백업 파일 보안

- MSG 파일은 **암호화되지 않습니다**
- 민감한 정보가 포함된 경우 백업 폴더에 **BitLocker** 또는 **폴더 암호화** 권장
- 백업 드라이브는 **방화벽/백신 예외 처리** 불필요 (로컬 저장)

### 매크로 보안

- 신뢰할 수 있는 소스의 매크로만 사용
- 이 매크로는 **파일 읽기/쓰기만** 수행하며 외부 통신 없음
- 코드 검토 후 사용 권장

## 📝 제한사항

1. **Outlook for Windows 전용** (Mac 버전 미지원)
2. **MailItem만 지원** (연락처, 일정 등 미지원)
3. **첨부파일 포함 저장** (MSG 파일 특성)
4. **네트워크 드라이브 사용 시** 성능 저하 가능
5. **대용량 메일** (>50MB)은 저장 시간이 오래 걸릴 수 있음

## 🛠️ 시스템 요구사항

- **OS**: Windows 7 이상
- **Outlook**: 2010 이상 (2013/2016/2019/365 권장)
- **권한**: 백업 폴더에 대한 읽기/쓰기 권한
- **디스크 공간**: 메일 용량에 따라 가변

## 📌 FAQ

### Q: 기존 메일도 백업할 수 있나요?
**A**: 네, `SaveSelectedMailsAsMSG` 매크로로 수동 백업 가능합니다.

### Q: 백업된 MSG 파일을 어떻게 여나요?
**A**: Outlook에서 직접 더블클릭하면 열립니다. 모든 첨부파일과 메타데이터가 보존됩니다.

### Q: 백업 파일을 다른 PC로 이동할 수 있나요?
**A**: 네, MSG 파일은 이식 가능합니다. 다른 PC의 Outlook에서도 열 수 있습니다.

### Q: 백업을 중지하려면?
**A**: Outlook 재시작 시 이벤트 핸들러가 초기화됩니다. 영구 중지는 `Application_Startup` 함수를 주석 처리하세요.

### Q: 여러 계정을 사용하는데 모두 백업되나요?
**A**: 기본 계정의 Inbox/Sent만 백업됩니다. 다른 계정은 추가 코드 수정 필요합니다.

### Q: 같은 메일을 여러 번 저장하면 어떻게 되나요?
**A**: 중복 저장 방지 기능으로 동일 메일은 한 번만 저장됩니다. EntryID를 기반으로 자동으로 중복을 감지합니다.

### Q: 한 달치·1년치 백업은 언제 실행하나요?
**A**: 수동으로 실행합니다. Alt+F8에서 다음 매크로를 선택해 실행하세요.
- `BackupLastMonthMails`: 오늘 기준 이전 한 달치
- `BackupLastYearMails`: 오늘 기준 이전 1년치
- `BackupLast2YearsMails`: 오늘 기준 이전 2년치
- `BackupLast3YearsMails`: 오늘 기준 이전 3년치

## 📄 라이선스

이 프로젝트는 자유롭게 사용, 수정, 배포할 수 있습니다.

## 🤝 기여

버그 리포트, 기능 제안, 코드 개선은 언제든 환영합니다.

## 📧 문의

프로젝트 관련 문의사항은 이슈로 등록해주세요.

---

**마지막 업데이트**: 2025-01-13
**버전**: 3.0 (중복 저장 방지, 한 달치 백업 기능 추가)
